<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulateur Trajet</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #2f2f2f; /* gris foncé */
      color: white;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    header {
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
      color: #f1f1f1;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: #3a3a3a;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0px 4px 10px rgba(0,0,0,0.5);
    }
    input {
      width: 90%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 6px;
      border: none;
    }
    button {
      background-color: #28a745; /* vert luxe */
      color: white;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    #result {
      margin-top: 20px;
      font-size: 22px;
      font-weight: bold;
    }
    footer {
      margin-top: 20px;
      font-size: 14px;
      color: #ccc;
    }
  </style>
</head>
<body>
  <header>
    <h1>Simulez votre trajet en quelques secondes</h1>
  </header>

  <div class="container">
    <input type="text" id="start" placeholder="Adresse de départ">
    <input type="text" id="end" placeholder="Adresse d'arrivée">
    <button onclick="calculatePrice()">Calculer</button>
    <div id="result"></div>
  </div>

  <footer>
    <p>Si le prix vous convient, cliquez pour réserver ✅</p>
  </footer>

  <script>
    const apiKey = "eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImUyYzViOTA2YmQyMzQ0NjU4YjMyYTZmOGYxMTdhMmY0IiwiaCI6Im11cm11cjY0In0=";

    const parisCodes = ["75001","75002","75003","75004","75005","75006","75007","75008","75009","75010",
      "75011","75012","75013","75014","75015","75016","75017","75018","75019","75020",
      "92100","92120","92130","92140","92170","92200","92210","92220","92240","92250",
      "92270","92300","92310","92320","92340","92370","92390","92410","92420","92430",
      "92450","93100","93110","93120","93130","93140","93170","93190","93200","93210",
      "93230","93260","93270","93290","93310","93320","93330","93340","93350","93360",
      "93370","93380","93390","93400","93410","93420","93430","93450","93460","94000",
      "94100","94110","94120","94130","94140","94150","94160","94170","94190","94200",
      "94210","94220","94230","94240","94250","94270","94290","94300","94340","94360","94380"
    ];

    async function getCoords(address) {
      const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
      const data = await response.json();
      if (data.length > 0) {
        return { lat: data[0].lat, lon: data[0].lon, display_name: data[0].display_name };
      }
      return null;
    }

    function extractPostal(displayName) {
      const match = displayName.match(/75\d{3}|92\d{3}|93\d{3}|94\d{3}/);
      return match ? match[0] : null;
    }

    async function getDistance(start, end) {
      const url = `https://api.openrouteservice.org/v2/directions/driving-car?api_key=${apiKey}&start=${start.lon},${start.lat}&end=${end.lon},${end.lat}`;
      const response = await fetch(url);
      const data = await response.json();
      return data.routes[0].summary.distance / 1000; // km
    }

    function calculateFare(distance, isParis) {
      let price = 0;

      if (isParis) {
        if (distance <= 2.5) price = 9;
        else if (distance <= 6) price = 14;
        else if (distance <= 10) price = 18;
        else if (distance <= 15) price = 22.5;
        else if (distance <= 20) price = 30;
        else price = 30 + (distance - 20) * 1.5;
      } else {
        if (distance <= 6) price = 12;
        else if (distance <= 10) price = 15;
        else if (distance <= 14) price = 20;
        else if (distance <= 20) price = 30;
        else price = 30 + (distance - 20) * 1.5;
      }
      return price;
    }

    async function calculatePrice() {
      const startAddress = document.getElementById("start").value;
      const endAddress = document.getElementById("end").value;
      if (!startAddress || !endAddress) {
        alert("Veuillez remplir les deux adresses.");
        return;
      }

      const start = await getCoords(startAddress);
      const end = await getCoords(endAddress);
      if (!start || !end) {
        alert("Adresse invalide.");
        return;
      }

      const distance = await getDistance(start, end);

      const startPostal = extractPostal(start.display_name);
      const endPostal = extractPostal(end.display_name);

      let isParis = false;
      let message = "Tarifs appliqués : France";

      if (startPostal && parisCodes.includes(startPostal) && (!endPostal || parisCodes.includes(endPostal))) {
        isParis = true;
        message = "Tarifs appliqués : Paris et petite couronne";
      } else if (startPostal && parisCodes.includes(startPostal) && (!endPostal || !parisCodes.includes(endPostal))) {
        isParis = true;
        message = "Tarifs appliqués : Paris (départ)";
      } else if (startPostal && !parisCodes.includes(startPostal)) {
        message = "Tarifs appliqués : IDF";
      }

      const price = calculateFare(distance, isParis);

      document.getElementById("result").innerHTML =
        `Distance : ${distance.toFixed(2)} km<br>
        Prix estimé : <strong>${price.toFixed(2)} €</strong><br>
        <em>${message}</em>`;
    }
  </script>
</body>
</html>